---
title: "Calculating habitat associations for mammals from camera trap data in La Gran Sabana, Venezuela (version 1)"
author: "Stachowicz, I; Ferrer-Paris J.R.; et al. (in prep)"
date: May 21, 2019
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)
```
# Methods

## Time series of Vegetation Indices

For the location of each camera, we downloaded the time series of  Terra Moderate Resolution Imaging Spectroradiometer (MODIS) Vegetation Indices (MOD13Q1) Version 6 with a temporal resolution of 16 days and a spatial resolution of 250 meter (Data source: https://lpdaac.usgs.gov/products/mod13q1v006/).

We used the Normalized Difference Vegetation Index (NDVI) measurements from 2010 to 2019. The time series have n=215 total measurements per camera, but we considered only those with good reliability and production quality (approx. `r  round(mean(is.na(qry))*100,1)` %) of the observations (see product user manual in https://lpdaac.usgs.gov/documents/103/MOD13_User_Guide_V6.pdf).

## Habitat classification

We classified the habitat around each camara using the irregular time series data of reliable NDVI measurements. We performed **partition around medoids** (*pam* method in  Kaufman and Rousseeuw 1990) to discriminate three main types of habitat corresponding to "savanna", "forest" and an intermediate "shrub" or "transitional" group.

## Dufrene-Legendre Indicator Species Analysis

We calculated **fidelity**, **relative abundance** and the **indicator value** of each speciees for the three habitat types identified previously (Dufrene and Legendre 1997). In order to apply this analysis we assumed that species detections are related to abundance and/or activity of individuals and these are in turn indicators of species preference to certain habitat conditions.

Here "fidelity" is the prevalence of the species in each habitat type (Nr of distinct cameras with detection / total nr of cameras in the group). "Relative abundance (or frequency)" is defined here as the relative number of detections of each species in each group (Nr. of detections in one group / total nr of detections). The "indicator value" (IV) is the product of fidelity and relative abundance and can be interpreted as a measure of the strength of the association of one species to a given habitat type.

# Results

## Assessing classification quality

The figure 1 show the silhouette plot of the resulting partitioning. The silhouette width is a measure of the reliability of the classification of each observation (camera location).

```{r Figura1,fig.align='center',fig.width=9,fig.height=7,fig.cap='Silhouette plot of the habitat classification'}
plot(hdvi)

```

For groups 1 and 3 the average sillhoutte width is large and all observations are well classified ($s_i>0$), while for the group 2 the average sillhoutte width is low and some observations lie between different groups and might have been misclassified ($s_i<0$).


## General results of indicator value analysis

The following tables shows the fidelity, relative abundance (or frecuency) and indicator value of each species to the groups of the classification.

```{r Fidelidad}
cat("Fidelity per classification group\n")

IV.GS$relfrq
```

```{r Abundancia}
cat("Relative frecuency per classification group\n")
IV.GS$relabu
```

```{r IV}
cat("Indicator value per classification group\n")
IV.GS$indval
```

## Results by groups: Savanna

```{r Figura2,fig.align='center',fig.width=8,fig.height=4.5,fig.cap='NDVI values for habitat type Savanna. Dark dots represent reliable, good quality measurements used in the analysis, and grey circles represent unreliable or low quality measurements.'}
slc <- grep("A201[5-7]",colnames(qry))
x <- as.numeric(substring(colnames(qry)[slc],2,5)) + (as.numeric(substring(colnames(qry)[slc],6,8))/365)
k <- 1
   matplot(x,t(ndvi.camara[grp %in% k,slc]),type="p",col=rgb(.5,.5,.5,.45),ylim=c(0,1),ylab="NDVI",xlab="",pch=1,axes=F)
    axis(2)
    axis(1,2015:2018,las=2,col.axis="grey35",lty=0,cex.axis=.8,line=-2)

    axis(1,seq(2015+(15/365),2016,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2016+(15/365),2017,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2017+(15/365),2018,by=30/365),month.abb,las=2,cex.axis=.65)
        matpoints(x,t(qry[grp %in% k,slc]),type="p",col=1,ylim=c(0,1),ylab="NDVI",xlab="",pch=19)
```

The first cluster group corresponds to savanna habitat and has  `r sum(grp %in% k)` cameras. These cameras were mostly classified as continuous savanna (S) or wooded savanna (s) during the sampling design:

```{r group1}
table(grp2[grp %in% k])

```

Most of the cameras in the blocks one and two belong to this group, as well as some cameras in other blocks:

```{r group1bloques}
table((camaras[grp %in% 1,"bloque"]))
```


In the figure 2 we show the NDVI values between 2015 and 2018 for the camera locations classified as group 1.

The NDVI value in this group is mostly between 0.4 and 0.7, with some seasonal obsevations below 0.4 (beginning of 2015 and 2016, but not evident in 2017).


```{r IV1}
k <- 1
ss <- IV.GS$maxcls %in% k 
dts.1 <- data.frame(fidelity=IV.GS$relfrq[ss,k],rel.freq=IV.GS$relabu[ss,k],ind.val=IV.GS$indval[ss,k],pval= IV.GS$pval[ss])
```

For `r  nrow(dts.1)` species the indicator value for this habitat is higher than for the other habitats. All species have high relative frecuency here (values equal or above `r  min(dts.1$rel.freq)`), but only `r  sum(dts.1$pval<0.05)` has high fidelity and thus high and significant indicator value  (p<0.05).

```{r IV1.rsm}
dts.1
```

## Results by groups: Forest

```{r Figura3,fig.align='center',fig.width=8,fig.height=5,fig.cap='NDVI values for habitat type Forest. Dark dots represent reliable, good quality measurements used in the analysis, and grey circles represent unreliable or low quality measurements.'}
slc <- grep("A201[5-7]",colnames(qry))
x <- as.numeric(substring(colnames(qry)[slc],2,5)) + (as.numeric(substring(colnames(qry)[slc],6,8))/365)
k <- 3
   matplot(x,t(ndvi.camara[grp %in% k,slc]),type="p",col=rgb(.5,.5,.5,.45),ylim=c(0,1),ylab="NDVI",xlab="",pch=1,axes=F)
    axis(2)
    axis(1,2015:2018,las=2,col.axis="grey35",lty=0,cex.axis=.8,line=-2)

    axis(1,seq(2015+(15/365),2016,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2016+(15/365),2017,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2017+(15/365),2018,by=30/365),month.abb,las=2,cex.axis=.65)
        matpoints(x,t(qry[grp %in% k,slc]),type="p",col=1,ylim=c(0,1),ylab="NDVI",xlab="",pch=19)
```

The third group corresponds to forest habitat  and has `r sum(grp %in% k)` cameras. The location of these cameras were mostly classified as continuous forest (B) during the sampling design:

```{r group3}
table(grp2[grp %in% k])

```

Most of the cameras in the blocks three and four belong to this group, as well as few cameras in blocks five, six and seven.

```{r group3bloques}
table((camaras[grp %in% k,"bloque"]))
```


In the figure 3 we show the NDVI values corresponding to the camera locations classified as group 3 between 2015 and 2018. 


The reliable NDVI measurements in this group is above 0.8 for most of the year with some isolated observation below this value.


```{r IV3}
ss <- IV.GS$maxcls %in% k 
dts.3 <- data.frame(fidelity=IV.GS$relfrq[ss,k],rel.freq=IV.GS$relabu[ss,k],ind.val=IV.GS$indval[ss,k],pval= IV.GS$pval[ss])
dts.3
```

For `r  nrow(dts.3)` species the indicator value for this habitat is higher than for the other habitats. All species have high relative frecuency here (values equal or above `r  min(dts.3$rel.freq)`), but fidelity is variable (values between `r  min(dts.3$fidelity)` and  `r  max(dts.3$fidelity)`). As much as `r  sum(dts.3$pval<0.05)` have significant association to this habitat (indicator value equal or above `r  min(dts.3$ind.val[dts.3$pval<0.05])` and p<0.05).


## Results by groups: Intermediate habitat

```{r Figura4,fig.align='center',fig.width=8,fig.height=5,fig.cap='NDVI values for intermediate/shrub habitat type. Black dots represent reliable, good quality measurements used in the analysis, and grey circles represent unreliable or low quality measurements.'}
slc <- grep("A201[5-7]",colnames(qry))
x <- as.numeric(substring(colnames(qry)[slc],2,5)) + (as.numeric(substring(colnames(qry)[slc],6,8))/365)
k <- 2
ss <- grp %in% k ##& hdvi$silinfo$widths[,3]<0
   matplot(x,t(ndvi.camara[ss,slc]),type="p",col=rgb(.5,.5,.5,.45),ylim=c(0,1),ylab="NDVI",xlab="",pch=1,axes=F)
    axis(2)
    axis(1,2015:2018,las=2,col.axis="grey35",lty=0,cex.axis=.8,line=-2)

    axis(1,seq(2015+(15/365),2016,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2016+(15/365),2017,by=30/365),month.abb,las=2,cex.axis=.65)
    axis(1,seq(2017+(15/365),2018,by=30/365),month.abb,las=2,cex.axis=.65)
##ss <- grp %in% k & hdvi$silinfo$widths[,3]>0
matpoints(x,t(qry[ss,slc]),type="p",col=1,ylim=c(0,1),ylab="NDVI",xlab="meses",pch=19)
##ss <- grp %in% k & hdvi$silinfo$widths[,3]<0
##matpoints(x,t(qry[ss,slc]),type="p",col=2,ylim=c(0,1),ylab="NDVI",xlab="meses",pch=19)
```

The second group in the classification corresponds to intermediate habitat between forest and savanna, this might represent "shrub" habitat or mixtures of forest and savanna.  `r sum(grp %in% k)` camera locations were assigned to this group The location of these cameras were selected to represent fragmented forest (b) or savanna (s):

```{r group2}
table(grp2[grp %in% k])

```

Cameras assigned to this group are present in different blocks, but specially in blocks five and six.

```{r group2bloques}
table((camaras[grp %in% k,"bloque"]))
```

This group has intermediate (0.5 to 0.9) values of NDVI (figure 4), but they are frequently below 0.8 (value for forest group). In some localities the NDVI values might be closer to the forest habitat (localities with negative silhoutte width in figure 1). 


```{r IV2}
ss <- IV.GS$maxcls %in% k 
##IV.GS$relabu[ss,k]
dts.2 <- data.frame(fidelity=IV.GS$relfrq[ss,k],rel.freq=IV.GS$relabu[ss,k],ind.val=IV.GS$indval[ss,k],pval= IV.GS$pval[ss])
dts.2
```

For `r  nrow(dts.2)` species the indicator value for this habitat is higher than for the other habitats. All species have high relative frecuency here (values equal or above `r  min(dts.2$rel.freq)`), but fidelity is variable (values between `r  min(dts.2$fidelity)` and  `r  max(dts.2$fidelity)`). Only `r  sum(dts.2$pval<0.05)` have significant association to this habitat (p<0.05).


# References

* Didan, K. (2015). MOD13Q1 MODIS/Terra Vegetation Indices 16-Day L3 Global 250m SIN Grid V006 [Data set]. NASA EOSDIS Land Processes DAAC. doi: 10.5067/MODIS/MOD13Q1.006
* Kaufman, L. and Rousseeuw, P.J. (1990). _Finding Groups in Data: An Introduction to Cluster Analysis_.  Wiley, New York.
* Dufrene, M. and Legendre, P.  1997.  Species assemblages and indicator species: the need for a flexible asymmetrical approach. Ecol. Monogr. 67(3):345-366.
