---
title: "Test of garden hunting hypothesis for mammals in La Gran Sabana, Venezuela using occupancy models"
author: "Stachowicz, I; Ferrer-Paris, J.R.; Sanchez-Mercado, A. (in prep)"
date: December 2, 2020
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)
require(unmarked)
require(AICcmodavg)
require(chron)
require(raster)
require(cluster)
require(MuMIn)
require(dplyr)


if (Sys.getenv("WORKDIR") == "") {
   ## for Izza:
   work.dir <- "D:/PROJECTS/Gran Sabana/Metodologia"
   script.dir <- "???"
} else {
   ## for JR:
   work.dir <- Sys.getenv("WORKDIR")
   script.dir <- Sys.getenv("SCRIPTDIR")
}

setwd(work.dir)
GIS.data <- sprintf("%s/Rdata/GIS.rda",script.dir)
load(GIS.data)

```

# Methods

## Model definition

## Covariates of probability of detection
## Covariates of probability of occupancy - frecuency of use

For the location of each camera, we downloaded the time series of  Terra Moderate Resolution Imaging Spectroradiometer (MODIS) Vegetation Indices (MOD13Q1) Version 6 with a temporal resolution of 16 days and a spatial resolution of 250 meter (Data source: https://lpdaac.usgs.gov/products/mod13q1v006/).

We used the Normalized Difference Vegetation Index (NDVI) measurements from 2010 to 2019. The time series have n=215 total measurements per camera, but we considered only those with good reliability and production quality of the observations (see product user manual in https://lpdaac.usgs.gov/documents/103/MOD13_User_Guide_V6.pdf).

## Habitat classification



# Results

## Goodness of fit

MacKenzie and Bailey Goodness-of-fit Test for  Royle-Nichols Occupancy Models.

```{r }
tbl <- data.frame()
for (arch in dir(sprintf("%s/Rdata/occuRN/",script.dir))) {
   load(sprintf("%s/Rdata/occuRN/%s",script.dir,arch))
 tbl <- rbind(tbl,data.frame(spp=sub(".rda$","",arch),
 n.detect= sum(UMF@y,na.rm=T),
ts03[c("chi.square","p.value","c.hat.est")],
large.coefs=min(max(abs(coef(fm01))),max(abs(coef(fm01)))),
large.SE=min(max(SE(fm01)),max(SE(fm01)))))

}
tbl %>% mutate(overdispersion=c.hat.est > 1 & c.hat.est <4, coef.problems=large.coefs>4 | large.SE>4) %>%
  mutate(lack.of.fit=p.value<.10 | p.value > .9 | c.hat.est > 4 | c.hat.est <0.30 ) -> tbl

  table(tbl$lack.of.fit,tbl$coef.problems)

```

These species show one or more signs of lack of fit, probably due to the low number of detections:

```{r }
tbl %>% filter(lack.of.fit)

```

These species appear to have  a good fit but might have problems with large coeficients and standard errors
```{r }
tbl %>% filter(!lack.of.fit & coef.problems) %>% arrange(c.hat.est)
```

For this species, the over-dispersion might be accounted for by using quasi-AICc
```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & overdispersion) %>% arrange(c.hat.est)
```

These species seem to have  a good fit and no signs of over-dispersion:

```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & !overdispersion) %>% arrange(c.hat.est)

```


## Model averaging

### L. rufaxilla


Sum of AICc weights indicate a clear effect of p(sfrz) and large support for lam(evi.mu). wcon has AICcw=0.29

```{r }
arch <- sprintf("%s/Rdata/occuRN/L.rufaxilla.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(buf.fragmen),lam(I(buf.fragmen^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)
```

Significant conditional coeficients for p(sfrz). Negative relationship with distance to conuco ("atracted") but non-significant effect of conucos

```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))


```


### C. paca

```{r }
arch <- sprintf("%s/Rdata/occuRN/C.paca.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
  oms <- dredge(fm03,rank="AICc",subset=dc(lam(buf.fragmen),lam(I(buf.fragmen^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Significant conditional coeficients for those parameters. Negative relationship with distance to conuco ("atracted") of conucos

```{r }
summary(model.avg(oms, subset = delta < 10))
```

### D. leporina
Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for those parameters. Weak negative ("avoids") non-significant effect of conucos

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.leporina.rda",script.dir)

lst <- (load(arch))
if (!"oms" %in% lst) {
##  oms <- dredge(fm03,rank="AICc",subset=dc(lam(buf.fragmen),lam(I(buf.fragmen^2)),))
  oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### C.thous

Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for lam(evi.mu) (negative association). Weak negative ("avoids") non-significant effect of conucos

```{r }
arch <- sprintf("%s/Rdata/occuRN/C.thous.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
  mavg <- model.avg(oms, subset = delta < 10)
  #summary(mavg)
  cbind( coef(mavg),confint(mavg))
```



### D. kappleri

Most support for p(sfrz)+lam(evi.mu) but no significant conditional coefficients . Very weak  non-significant effect of conucos.

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.kappleri.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
  oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```

### C. alector

Most support for p(dras)+p(sfrz)+lam(evi.mu)+lam(wcon), significant conditional coeficients for those parameters. Strong negative significative effect of conucos.

```{r }
arch <- sprintf("%s/Rdata/occuRN/C.alector.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
  oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```



### L. pardalis

Most support for p(dras)+p(sfrz)+lam(evi.mu)+lam(wcon), significant conditional coeficients for those parameters. Strong negative significative effect of conucos.

```{r }
arch <- sprintf("%s/Rdata/occuRN/L.pardalis.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```












### D. novemcinctus

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.novemcinctus.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### M. americana
 Best model is p(date)   p(sfrz) lam(evi.mu) but very large coeficients for p(Int) and p(sfrz)
```{r }
arch <- sprintf("%s/Rdata/occuRN/M.americana.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm01,rank="AICc")
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### T.tetradactyla

Null model is best model
```{r }
arch <- sprintf("%s/Rdata/occuRN/T.tetradactyla.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### E.barbara
```{r }
arch <- sprintf("%s/Rdata/occuRN/E.barbara.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```



### T.terrestris


```{r }
arch <- sprintf("%s/Rdata/occuRN/T.terrestris.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### D.imperfecta

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.imperfecta.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
sw(oms)

```

Coeficients with 95% CI
```{r }
mavg <- model.avg(oms, subset = delta < 10)
#summary(mavg)
cbind( coef(mavg),confint(mavg))
```


### M.gouazoubira

```{r }
arch <- sprintf("%s/Rdata/occuRN/M.gouazoubira.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
summary(model.avg(oms, subset = delta < 10))
```

### N.nasua

```{r }
arch <- sprintf("%s/Rdata/occuRN/N.nasua.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
summary(model.avg(oms, subset = delta < 10))
```

### M.tridactyla

```{r }
arch <- sprintf("%s/Rdata/occuRN/M.tridactyla.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm03,rank="AICc",subset=dc(lam(evi.mu),lam(I(evi.mu^2)),))
   save(file=arch,list=c(lst,"oms"))
}
summary(model.avg(oms, subset = delta < 10))
```


### P. onca

If c-hat >1, then we use QAICc

```{r }
arch <- sprintf("%s/Rdata/occuRN/P.onca.rda",script.dir)
lst <- (load(arch))
if (!"oms" %in% lst) {
   oms <- dredge(fm01,rank="QAICc",chat=ts03$c.hat.est)
   save(file=arch,list=c(lst,"oms"))
}
summary(model.avg(oms, subset = delta < 10))

```

Sum of QAICc-weights
```{r }
sw(oms)
```



<!--
avgmod.95p <- model.avg(oms, cumsum(weight) <= .95,fit=T)
prd <- predict(avgmod.95p,type='state')



summary(avgmod.95p)
aggregate(prd$fit,list(UMF@siteCovs$bloque),sum)
 aggregate(prd$fit,list(UMF@siteCovs$caza.celda),mean)
boxplot(prd$fit~UMF@siteCovs$caza.celda,varwidth=T)





aggregate(confint(ranef(fm01,K=50), level=0.95),list(UMF@siteCovs$bloque),sum)
aggregate(confint(ranef(fm01,K=50), level=0.95),list(UMF@siteCovs$caza.celda),sum) -->
