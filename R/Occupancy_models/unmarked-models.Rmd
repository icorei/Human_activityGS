---
title: "Test of garden hunting hypothesis for mammals in La Gran Sabana, Venezuela using occupancy models"
author: "Stachowicz, I; Ferrer-Paris, J.R.; Sanchez-Mercado, A. (in prep)"
date: December 2, 2020
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)
require(unmarked)
require(AICcmodavg)
require(chron)
require(raster)
require(cluster)
require(MuMIn)
require(dplyr)
require(ggplot2)


if (Sys.getenv("WORKDIR") == "") {
   ## for Izza:
   work.dir <- "D:/PROJECTS/Gran Sabana/Metodologia"
   script.dir <- "???"
} else {
   ## for JR:
   work.dir <- Sys.getenv("WORKDIR")
   script.dir <- Sys.getenv("SCRIPTDIR")
}

setwd(work.dir)
GIS.data <- sprintf("%s/Rdata/GIS.rda",script.dir)
load(GIS.data)

```

# Methods

## Model definition

## Covariates of probability of detection

dras: distance to animal tracks and trails

sfrz: sampling effort (nr. of days camera was active)

date: date of sampling

## Covariates of probability of occupancy - frecuency of use

buf.fragmen: 1 km buffer of forest cover derived from LandSat time series (Hansen et al. 2013)

dcon: distance to nearest conuco


```r
dconucos <- pointDistance(coordinates(conucos)[,1:2], camaras[,c("lon","lat")], lonlat=TRUE)


  p <- 1/5
  w <- 1/((dconucos)^p)
  idw.conucos <- apply(w,2,sum)
  camaras$idw.conucos <- apply(w,2,sum)

#distance to nearest
camaras$min.conucos <- apply(dconucos,2,min)


  ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=min.conucos,fill=as.factor(caza.celda))) + geom_histogram(binwidth=500, alpha = .8,col='black') +
 labs(title="Histogram for distance to conucos") +
 labs(x="Distance (m)", y="Count")


   ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=wcon,fill=as.factor(caza.celda))) + geom_histogram(alpha = .8,col='black') +
  labs(title="Histogram for distance to conucos") +
  labs(x="Distance (m)", y="Count")

 subset(camaras,bloque %in% sprintf("B%02s",1:6) & min.conucos>7000)

```

```r

   ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=buf.fragmen,fill=as.factor(caza.celda))) + geom_histogram(binwidth=5, alpha = .8,col='black') +
  labs(title="Histogram for forest cover") +
  labs(x="Percentage cover", y="Count")


#ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=min.conucos)) +
#    geom_boxplot()

#    ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=dcom)) +
#        geom_boxplot()
# dev.flush()

#ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=dcom)) +
#    geom_hist()

```

```r

    ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=buf.fragmen,fill=bloque)) + geom_histogram(binwidth=5, alpha = .8,col='black') +
   labs(title="Histogram for forest cover") +
   labs(x="Percentage cover", y="Count")



```



```r

     ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(y=min.conucos,x=buf.fragmen,colour=as.factor(caza.celda),size=caza.celda)) +
       geom_point() +
       labs(title="Forest cover vs distance to conuco") +
      labs(y="Distance (m)", x="Forest cover (%)")


           ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(y=wcon,x=buf.fragmen,colour=as.factor(caza.celda),size=caza.celda)) +
             geom_point() +
             labs(title="Forest cover vs density of conuco") +
            labs(y="Density", x="Forest cover (%)")



```

Eliminar tres puntos mas remotos (> 5km del conuco)


```r

ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(y=idw.conucos,x=min.conucos,colour=as.factor(caza.celda),size=caza.celda)) +
  geom_point()

  #                 +
  #                 labs(title="Forest cover vs density of conuco") +
  #                labs(y="Density", x="Forest cover (%)")


```


# Results

## Goodness of fit

MacKenzie and Bailey Goodness-of-fit Test for  Royle-Nichols Occupancy Models.

```{r }
if (!exists("tbl")) {
  tbl <- data.frame()
  for (arch in dir(sprintf("%s/Rdata/occuRN/",script.dir))) {
    load(sprintf("%s/Rdata/occuRN/%s",script.dir,arch))
  mi.spp <- sub(".rda$","",arch)
  UMF <- get(sprintf("UMF.%s",mi.spp))
  ts03 <- get(sprintf("ts03.%s",mi.spp))
  fm01 <- get(sprintf("fm01.%s",mi.spp))
  fm03 <- get(sprintf("fm03.%s",mi.spp))

   tbl <- rbind(tbl,data.frame(spp=mi.spp,
   n.detect= sum(UMF@y,na.rm=T),
  ts03[c("chi.square","p.value","c.hat.est")],
  large.coefs=min(max(abs(coef(fm01))),max(abs(coef(fm03)))),
  large.SE=min(max(SE(fm01)),max(SE(fm03)))))

  }
  tbl %>% mutate(overdispersion=c.hat.est > 1 & c.hat.est <4, coef.problems=large.coefs>4 | large.SE>4) %>%
    mutate(lack.of.fit=p.value<.10 | p.value > .9 | c.hat.est > 4 | c.hat.est <0.30 ) -> tbl

}

```

Symptoms of lack of fit for most species: Six models with extreme p-value or c-hat values, 19 models with large coeficients or standard errors.

```{r }
table(tbl$lack.of.fit,tbl$coef.problems)

```

These species show one or more signs of lack of fit, probably due to the low number of detections:

```{r }
tbl %>% filter(lack.of.fit) %>% select(1:7)

```

These species appear to have  a good fit but might have problems with large coeficients and standard errors
```{r }
tbl %>% filter(!lack.of.fit & coef.problems) %>% arrange(c.hat.est) %>% select(1:7)
```

For this species, the over-dispersion might be accounted for by using quasi-AICc
```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & overdispersion) %>% arrange(c.hat.est) %>% select(1:7)
```

These species seem to have  a good fit and no signs of over-dispersion:

```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & !overdispersion) %>% arrange(c.hat.est) %>% select(1:7)

```


## Model averaging

### Variable importance

```{r }
ccs <- data.frame()
for (spp in c('D.leporina','L.pardalis','C.alector','C.thous','P.onca','D.novemcinctus','M.gouazoubira','D.kappleri','C.paca','L.rufaxilla','E.barbara')) {
  print(spp)
  if (spp %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
    print(sw(get(sprintf("oms03.%s",spp))))
    mavg <- model.avg(get(sprintf("oms03.%s",spp)), subset = delta < 10)
  } else {
    print(sw(get(sprintf("oms01.%s",spp))))
    mavg <- model.avg(get(sprintf("oms01.%s",spp)), subset = delta < 10)
  }
  ccs <- rbind(ccs,data.frame(spp, coef(mavg,full=F),confint(mavg,full=F)))
}

```



```{r eval=false}
ccs <- data.frame()
for (spp in c('D.leporina','L.pardalis','C.alector','C.thous','P.onca','D.novemcinctus','M.gouazoubira','D.kappleri','C.paca','L.rufaxilla')) {
  print(spp)
  if (spp %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
    print(sw(get(sprintf("oms13.%s",spp))))
    mavg <- model.avg(get(sprintf("oms13.%s",spp)), subset = delta < 10)
  } else {
    print(sw(get(sprintf("oms11.%s",spp))))
    mavg <- model.avg(get(sprintf("oms11.%s",spp)), subset = delta < 10)
  }
  ccs <- rbind(ccs,data.frame(spp, coef(mavg,full=F),confint(mavg,full=F)))
}

```

```{r}
ccs  %>% filter(grepl('buf.fragmen',rownames(ccs))) %>% dplyr::arrange(coef.mavg..full...F.) -> ss

plot(ss$coef.mavg.,1:nrow(ss),xlim=c(-2.3,2.3),pch=19,xlab='',ylab='',axes=F,main='buf.fragmen')
segments(ss$X2.5..,   1:nrow(ss),   ss$X97.5..,1:nrow(ss))
axis(1)
axis(2,1:nrow(ss),ss$spp,las=2)
box()
abline(v=0,lty=2,lwd=2,col=2)
```



```{r}
ccs  %>% filter(grepl('wcon',rownames(ccs))) %>% dplyr::arrange(coef.mavg..full...F.) -> ss
par(mar=c(4,8,3,1))
plot(ss$coef.mavg.,1:nrow(ss),xlim=c(-3.2,3.2),pch=19,xlab=expression(hat(beta)),ylab='',axes=F,main='conuco density')
segments(ss$X2.5..,   1:nrow(ss),   ss$X97.5..,1:nrow(ss))
axis(1)
axis(2,1:nrow(ss),ss$spp,las=2,font=3)
box()
abline(v=0,lty=2,lwd=2,col=2)
```


## Hunting


```{r}

mtz <- data.frame()

for (k in c('C.paca','C.alector', 'D.leporina', 'M.gouazoubira', 'D.kappleri', 'D.novemcinctus', 'L.rufaxilla', 'L.pardalis','C.thous','P.onca')) {
  if (k %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
      mtz <- rbind(mtz,data.frame(species=k,abundance=predict(get(sprintf("mavg03.%s",k)),type='state')$fit,caza=UMF@siteCovs$caza.celda))
    } else {
      mtz <- rbind(mtz,data.frame(species=k,abundance=predict(get(sprintf("mavg01.%s",k)),type='state')$fit,caza=UMF@siteCovs$caza.celda))
    }
}

mtz$hunting <- ifelse(mtz$caza==1,'yes','no')
mtz$hunting <- ifelse(mtz$caza>0,'yes','no')


# grouped boxplot
ggplot(mtz, aes(x=species, y=abundance, fill=hunting)) + ylab(expression(Sigma * hat(lambda))) +
    geom_boxplot()


```

## results per species



### C. paca


Sum of AICc weights indicate a clear effect of p(sfrz) p(dras) and lam(dcon)

```{r }
summary(mavg13.C.paca)


```

Significant conditional coeficients for those parameters. Negative relationship with distance to conuco ("atracted") of conucos
`

### D. leporina
Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for those parameters. Weak negative ("avoids") non-significant effect of conucos

```{r }
summary(mavg01.D.leporina)


```

```{r }
prd <- predict(mavg01.D.leporina,type='state')

    dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$wcon)

    ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

```


### C. alector

Most support for p(dras)+p(sfrz)+lam(evi.mu)+lam(wcon), significant conditional coeficients for those parameters. Strong negative significative effect of conucos.

```{r }
summary(mavg11.C.alector)

```


```{r }
prd <- predict(mavg11.C.alector,type='state')
##prd <- ranef(mavg01.C.alector,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,wcon=UMF@siteCovs$wcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(x=wcon, y=prd,colour=factor(caza))) +
  geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
    geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

    ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("bosque") + ylab("Predicted values") + labs(colour='Hunting')

```

### L. rufaxilla

Sum of AICc weights indicate a clear effect of p(sfrz) and large support for lam(buf.fragmen). Almost half of the models support lam(dcon)

```{r }
summary(mavg03.L.rufaxilla)

```

Significant conditional coeficients for p(sfrz). Negative relationship with distance to conuco ("atracted") but non-significant effect of conucos



```{r }
prd <- predict(mavg03.L.rufaxilla,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


    ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

        ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
          geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
            geom_point() + xlab("forest cover") + ylab("Predicted values") + labs(colour='Hunting')

```
### C.thous

Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for lam(evi.mu) (negative association). Weak negative ("avoids") non-significant effect of conucos

```{r }
summary(mavg01.C.thous)

```


```{r }
prd <- predict(mavg01.C.thous,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
  geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
    geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

    ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("forest cover") + ylab("Predicted values") + labs(colour='Hunting')

```




### D. kappleri

Most support for p(sfrz)+lam(evi.mu) but no significant conditional coefficients . Very weak  non-significant effect of conucos.



### L. pardalis

Most support for null model.

```{r }
summary(mavg01.L.pardalis)

```



```{r }
prd <- predict(mavg01.L.pardalis,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
  geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
    geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

    ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("forest cover") + ylab("Predicted values") + labs(colour='Hunting')

```






### D. novemcinctus
``


### M. americana


### T.tetradactyla



### E.barbara

Large coefficients lead to large, unrealistic abundance predictions

```{r }
summary(mavg01.E.barbara)

```

```{r }
prd <- predict(mavg01.E.barbara,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(y=dcon, x=bsq,size=prd,colour=factor(caza))) +
    geom_point() + ylab("distance to conucos  (standardised values)") + xlab("Forest cover (standardised values)") + labs(colour='Hunting',size='Predicted values')


```


### T.terrestris

Very large standard errors
```{r }
summary(mavg03.T.terrestris)

```


```{r }
prd <- predict(mavg03.T.terrestris,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(y=dcon, x=bsq,size=prd,colour=factor(caza))) +
    geom_point() + ylab("distance to conucos  (standardised values)") + xlab("Forest cover (standardised values)") + labs(colour='Hunting',size='Predicted values')


```


### D.imperfecta



### M.gouazoubira


### N.nasua


### M.tridactyla



### P. onca
