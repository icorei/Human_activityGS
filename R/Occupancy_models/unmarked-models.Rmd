---
title: "Test of garden hunting hypothesis for mammals in La Gran Sabana, Venezuela using occupancy models"
author: "Stachowicz, I; Ferrer-Paris, J.R.; Sanchez-Mercado, A. (in prep)"
date: December 2, 2020
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)
require(unmarked)
require(AICcmodavg)
require(chron)
require(raster)
require(cluster)
require(MuMIn)
require(dplyr)
require(ggplot2)


if (Sys.getenv("WORKDIR") == "") {
   ## for Izza:
   work.dir <- "D:/PROJECTS/Gran Sabana/Metodologia"
   script.dir <- "???"
} else {
   ## for JR:
   work.dir <- Sys.getenv("WORKDIR")
   script.dir <- Sys.getenv("SCRIPTDIR")
}

setwd(work.dir)
GIS.data <- sprintf("%s/Rdata/GIS.rda",script.dir)
load(GIS.data)

```

# Methods

## Model definition

## Covariates of probability of detection

dras: distance to animal tracks and trails

sfrz: sampling effort (nr. of days camera was active)

date: date of sampling

## Covariates of probability of occupancy - frecuency of use

buf.fragmen: 1 km buffer of forest cover derived from LandSat time series (Hansen et al. 2013)

dcon: distance to nearest conuco
<!-- For the location of each camera, we downloaded the time series of  Terra Moderate Resolution Imaging Spectroradiometer (MODIS) Vegetation Indices (MOD13Q1) Version 6 with a temporal resolution of 16 days and a spatial resolution of 250 meter (Data source: https://lpdaac.usgs.gov/products/mod13q1v006/).

We used the Normalized Difference Vegetation Index (NDVI) measurements from 2010 to 2019. The time series have n=215 total measurements per camera, but we considered only those with good reliability and production quality of the observations (see product user manual in https://lpdaac.usgs.gov/documents/103/MOD13_User_Guide_V6.pdf).

## Habitat classification

-->

```r

dconucos <- pointDistance(coordinates(conucos)[,1:2], camaras[,c("lon","lat")], lonlat=TRUE)

#distance to nearest
camaras$min.conucos <- apply(dconucos,2,min)

ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=min.conucos)) +
    geom_boxplot()

    ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=dcom)) +
        geom_boxplot()
# dev.flush()
subset(camaras,bloque %in% sprintf("B%02s",1:6) & min.conucos>7000)

ggplot(subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=factor(caza.celda), y=dcom)) +
    geom_hist()


    ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=buf.fragmen,fill=bloque)) + geom_histogram(binwidth=5, alpha = .8,col='black') +
   labs(title="Histogram for forest cover") +
   labs(x="Percentage cover", y="Count")

   ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=buf.fragmen,fill=as.factor(caza.celda))) + geom_histogram(binwidth=5, alpha = .8,col='black') +
  labs(title="Histogram for forest cover") +
  labs(x="Percentage cover", y="Count")

  ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(x=min.conucos,fill=as.factor(caza.celda))) + geom_histogram(binwidth=500, alpha = .8,col='black') +
 labs(title="Histogram for distance to conucos") +
 labs(x="Distance (m)", y="Count")
   
    ggplot(data=subset(camaras,bloque %in% sprintf("B%02s",1:6)), aes(min.conucos)) +
      geom_histogram(binwidth=500, col="red", fill="green", alpha = .2) +
     labs(title="Histogram for distance to conuco") +
     labs(x="Distance (m)", y="Count")
     ##+ xlim(c(18,52)) + ylim(c(0,30))
```


# Results

## Goodness of fit

MacKenzie and Bailey Goodness-of-fit Test for  Royle-Nichols Occupancy Models.

```{r }
if (!exists("tbl")) {
  tbl <- data.frame()
  for (arch in dir(sprintf("%s/Rdata/occuRN/",script.dir))) {
    load(sprintf("%s/Rdata/occuRN/%s",script.dir,arch))
  mi.spp <- sub(".rda$","",arch)
  UMF <- get(sprintf("UMF.%s",mi.spp))
  ts03 <- get(sprintf("ts03.%s",mi.spp))
  fm01 <- get(sprintf("fm01.%s",mi.spp))
  fm03 <- get(sprintf("fm03.%s",mi.spp))

   tbl <- rbind(tbl,data.frame(spp=mi.spp,
   n.detect= sum(UMF@y,na.rm=T),
  ts03[c("chi.square","p.value","c.hat.est")],
  large.coefs=min(max(abs(coef(fm01))),max(abs(coef(fm03)))),
  large.SE=min(max(SE(fm01)),max(SE(fm03)))))

  }
  tbl %>% mutate(overdispersion=c.hat.est > 1 & c.hat.est <4, coef.problems=large.coefs>4 | large.SE>4) %>%
    mutate(lack.of.fit=p.value<.10 | p.value > .9 | c.hat.est > 4 | c.hat.est <0.30 ) -> tbl

}

```

Symptoms of lack of fit for most species: Six models with extreme p-value or c-hat values, 19 models with large coeficients or standard errors.

```{r }
table(tbl$lack.of.fit,tbl$coef.problems)

```

These species show one or more signs of lack of fit, probably due to the low number of detections:

```{r }
tbl %>% filter(lack.of.fit) %>% select(1:7)

```

These species appear to have  a good fit but might have problems with large coeficients and standard errors
```{r }
tbl %>% filter(!lack.of.fit & coef.problems) %>% arrange(c.hat.est) %>% select(1:7)
```

For this species, the over-dispersion might be accounted for by using quasi-AICc
```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & overdispersion) %>% arrange(c.hat.est) %>% select(1:7)
```

These species seem to have  a good fit and no signs of over-dispersion:

```{r }
tbl %>% filter(!lack.of.fit & !coef.problems & !overdispersion) %>% arrange(c.hat.est) %>% select(1:7)

```


## Model averaging

### Variable importance

```{r }
ccs <- data.frame()
for (spp in c('D.leporina','L.pardalis','C.alector','C.thous','P.onca','D.novemcinctus','M.gouazoubira','D.kappleri','C.paca','L.rufaxilla')) {
  print(spp)
  if (spp %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
    print(sw(get(sprintf("oms03.%s",spp))))
    mavg <- model.avg(get(sprintf("oms03.%s",spp)), subset = delta < 10)
  } else {
    print(sw(get(sprintf("oms01.%s",spp))))
    mavg <- model.avg(get(sprintf("oms01.%s",spp)), subset = delta < 10)
  }
  ccs <- rbind(ccs,data.frame(spp, coef(mavg,full=F),confint(mavg,full=F)))
}

```



```{r eval=false}
ccs <- data.frame()
for (spp in c('D.leporina','L.pardalis','C.alector','C.thous','P.onca','D.novemcinctus','M.gouazoubira','D.kappleri','C.paca','L.rufaxilla')) {
  print(spp)
  if (spp %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
    print(sw(get(sprintf("oms13.%s",spp))))
    mavg <- model.avg(get(sprintf("oms13.%s",spp)), subset = delta < 10)
  } else {
    print(sw(get(sprintf("oms11.%s",spp))))
    mavg <- model.avg(get(sprintf("oms11.%s",spp)), subset = delta < 10)
  }
  ccs <- rbind(ccs,data.frame(spp, coef(mavg,full=F),confint(mavg,full=F)))
}

```

```{r}
ccs  %>% filter(grepl('buf.fragmen',rownames(ccs))) %>% dplyr::arrange(coef.mavg..full...F.) -> ss

plot(ss$coef.mavg.,1:nrow(ss),xlim=c(-2.3,2.3),pch=19,xlab='',ylab='',axes=F,main='buf.fragmen')
segments(ss$X2.5..,   1:nrow(ss),   ss$X97.5..,1:nrow(ss))
axis(1)
axis(2,1:nrow(ss),ss$spp,las=2)
box()
abline(v=0,lty=2,lwd=2,col=2)
```



```{r}
ccs  %>% filter(grepl('dcon',rownames(ccs))) %>% dplyr::arrange(coef.mavg..full...F.) -> ss
par(mar=c(4,8,3,1))
plot(ss$coef.mavg.,1:nrow(ss),xlim=c(-2.3,2.3),pch=19,xlab=expression(hat(beta)),ylab='',axes=F,main='distance to conuco')
segments(ss$X2.5..,   1:nrow(ss),   ss$X97.5..,1:nrow(ss))
axis(1)
axis(2,1:nrow(ss),ss$spp,las=2,font=3)
box()
abline(v=0,lty=2,lwd=2,col=2)
```


## Hunting


```{r}

mtz <- data.frame()

for (k in c('C.alector', 'C.paca', 'D.leporina', 'M.gouazoubira', 'D.kappleri', 'D.novemcinctus', 'L.rufaxilla', 'L.pardalis','C.thous','P.onca')) {
  if (k %in% c('C.paca','L.pardalis','D.novemcinctus','L.rufaxilla')) {
      mtz <- rbind(mtz,data.frame(species=k,abundance=predict(get(sprintf("mavg03.%s",k)),type='state')$fit,caza=UMF@siteCovs$caza.celda))
    } else {
      mtz <- rbind(mtz,data.frame(species=k,abundance=predict(get(sprintf("mavg01.%s",k)),type='state')$fit,caza=UMF@siteCovs$caza.celda))
    }
}

mtz$hunting <- ifelse(mtz$caza==1,'yes','no')
mtz$hunting <- ifelse(mtz$caza>0,'yes','no')


# grouped boxplot
ggplot(mtz, aes(x=species, y=abundance, fill=hunting)) + ylab(expression(Sigma * hat(lambda))) +
    geom_boxplot()


```

## results per species



### C. paca


Sum of AICc weights indicate a clear effect of p(sfrz) p(dras) and lam(dcon)

```{r }
summary(mavg03.C.paca)


```

Significant conditional coeficients for those parameters. Negative relationship with distance to conuco ("atracted") of conucos
`

### D. leporina
Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for those parameters. Weak negative ("avoids") non-significant effect of conucos

```{r }
summary(mavg01.D.leporina)


```

```{r }
prd <- predict(mavg01.D.leporina,type='state')

    dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon)

    ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

```


### C. alector

Most support for p(dras)+p(sfrz)+lam(evi.mu)+lam(wcon), significant conditional coeficients for those parameters. Strong negative significative effect of conucos.

```{r }
summary(mavg01.C.alector)

```


```{r }
prd <- predict(mavg01.C.alector,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon)


    ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

```

### L. rufaxilla

Sum of AICc weights indicate a clear effect of p(sfrz) and large support for lam(buf.fragmen). Almost half of the models support lam(dcon)

```{r }
summary(mavg03.L.rufaxilla)

```

Significant conditional coeficients for p(sfrz). Negative relationship with distance to conuco ("atracted") but non-significant effect of conucos



```{r }
prd <- predict(mavg03.L.rufaxilla,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


    ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

        ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
          geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
            geom_point() + xlab("forest cover") + ylab("Predicted values") + labs(colour='Hunting')

```
### C.thous

Used linear model for EVI. Most support for p(sfrz)+lam(evi.mu), significant conditional coefficients for lam(evi.mu) (negative association). Weak negative ("avoids") non-significant effect of conucos

```{r }
summary(mavg01.C.thous)

```


```{r }
prd <- predict(mavg01.C.thous,type='state')
dtf <- data.frame(prd=prd$fit,se=prd$se.fit,caza=UMF@siteCovs$caza.celda,dcon=UMF@siteCovs$dcon,bsq=UMF@siteCovs$buf.fragmen)


ggplot(dtf, aes(x=dcon, y=prd,colour=factor(caza))) +
  geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
    geom_point() + xlab("distance to conucos") + ylab("Predicted values") + labs(colour='Hunting')

    ggplot(dtf, aes(x=bsq, y=prd,colour=factor(caza))) +
      geom_errorbar(aes(ymin=prd-se, ymax=prd+se), colour="grey", width=0.025) +
        geom_point() + xlab("forest cover") + ylab("Predicted values") + labs(colour='Hunting')

```




### D. kappleri

Most support for p(sfrz)+lam(evi.mu) but no significant conditional coefficients . Very weak  non-significant effect of conucos.

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.kappleri.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))

```


### L. pardalis

Most support for p(dras)+p(sfrz)+lam(evi.mu)+lam(wcon), significant conditional coeficients for those parameters. Strong negative significative effect of conucos.

```{r }
arch <- sprintf("%s/Rdata/occuRN/L.pardalis.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))

```












### D. novemcinctus

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.novemcinctus.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))

```


### M. americana
 Best model is p(date)   p(sfrz) lam(evi.mu) but very large coeficients for p(Int) and p(sfrz)
```{r }
arch <- sprintf("%s/Rdata/occuRN/M.americana.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))

```


### T.tetradactyla

Null model is best model
```{r }
arch <- sprintf("%s/Rdata/occuRN/T.tetradactyla.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))

```


### E.barbara
```{r }
arch <- sprintf("%s/Rdata/occuRN/E.barbara.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))
```



### T.terrestris


```{r }
arch <- sprintf("%s/Rdata/occuRN/T.terrestris.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))
```


### D.imperfecta

```{r }
arch <- sprintf("%s/Rdata/occuRN/D.imperfecta.rda",script.dir)
load(arch)
summary(model.avg(oms, subset = delta < 10))
```


### M.gouazoubira

```{r }
arch <- sprintf("%s/Rdata/occuRN/M.gouazoubira.rda",script.dir)
lst <- (load(arch))
summary(model.avg(oms, subset = delta < 10))
```

### N.nasua

```{r }
arch <- sprintf("%s/Rdata/occuRN/N.nasua.rda",script.dir)
lst <- (load(arch))
summary(model.avg(oms, subset = delta < 10))
```

### M.tridactyla

```{r }
arch <- sprintf("%s/Rdata/occuRN/M.tridactyla.rda",script.dir)
lst <- (load(arch))
summary(model.avg(oms, subset = delta < 10))
```


### P. onca

If c-hat >1, then we use QAICc

```{r }
arch <- sprintf("%s/Rdata/occuRN/P.onca.rda",script.dir)
lst <- (load(arch))
summary(model.avg(oms, subset = delta < 10))
```
